---
title: "Passage to Spawner Submodel"
# output: html_document # to see tabset
output:
  html_document:
  theme: flatly
# output: rmarkdown::html_vignette
# output: rmarkdown::word_document
author:
  - Liz Stebbins, Ashley Vizek, Erin Cain, Josh Korman
vignette: >
  %\VignetteIndexEntry{Passage to Spawner Submodel}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7,
  fig.height = 5
)
```

```{r setup, include = FALSE}
library(ggplot2)
library(tidyverse)
library(bayesplot)
library(wesanderson)
library(SRJPEdata)
library(SRJPEmodel)
```

```{r, echo = FALSE, message = FALSE, warning = FALSE}
observed_adult_input <- SRJPEdata::observed_adult_input
adult_model_covariates <- SRJPEdata::adult_model_covariates_standard
```

## Overview

The Passage to Spawner (P2S) is a Bayesian model that produces estimates of spawning adults for `Battle Creek`, `Clear Creek`, `Deer Creek`, and `Mill Creek` with uncertainty. The model can be used to get spawning adults for a tributary as part of any stock-recruit-based SRJPE model alternative.

## Submodel Objective
The purpose of the P2S submodel is to take in observed upstream passage, or escapement, estimates from a tributary and model the relationship with spawner counts, either from redd surveys or holding surveys. The P2S produces estimated spawner counts with uncertainty for use in creating the `stock` portion of a `stock-recruit mdoel` in the SRJPE.

The model also estimates a `conversion rate`, or proportion of adults that pass though the video counting systems that become spawning adults (i.e. prespawn mortality). The P2S can also be used for forecasting; it takes in a standardized environmental covariate and uses this variable to predict spawners from upstream passage counts. In this way, the P2S provides resiliency for years where data may be missing (i.e. years where upstream passage data were collected but spawner surveys were not conducted).

## Conceptual model
Insert conceptual model of SRJPE here with the P2S model included.

## Submodel Architecture

The submodel takes observed data (in orange) and predicts spawner counts (in pink). Parameters estimated by the model are light pink; for more information, see documentation.

```{r, echo = FALSE, out.width = "600px"}
knitr::include_graphics(path = here::here("data-raw", "adult_model", "adult_model_plots", "parameter_diagram.png"),
                        rel_path = FALSE)
```

# Model inputs

The model takes in two datasets:

* **Observed adult counts** or estimates from all methods (upstream passage, holding surveys, redd surveys, and carcass surveys) aggregated by year and stream. This is in the `SRJPEdata::observed_adult_input` data object.
* **Observed environmental covariates** aggregated by year within streams, and standardized (scaled to center on 0). This is in the `SRJPEdata::adult_model_covariates_standard` object.

# Running the P2S submodel

To run the model, load the necessary data from `SRJPEdata`:

```{r, message = FALSE, warning = FALSE, eval = FALSE}
observed_adult_input <- SRJPEdata::observed_adult_input
adult_model_covariates <- SRJPEdata::adult_model_covariates_standard
```

The model can then be run for a given stream and environmental covariate.
* Options for streams are `battle creek`, `clear creek`, `deer creek`, and `mill creek`.
* Environmental covariates are `water year type`, `growing degree days`, and `maximum flow`.

```{r, message = FALSE, warning = FALSE, eval = FALSE}
# run the model for battle creek and water year type
battle_P2S_results <- run_passage_to_spawner_model(observed_adult_input,
                                                   adult_model_covariates,
                                                   "battle creek",
                                                   "wy_type")
# run the model for clear creek and water year type
clear_P2S_results <- run_passage_to_spawner_model(observed_adult_input,
                                                  adult_model_covariates,
                                                  "clear creek",
                                                  "wy_type")
# run the model for deer creek and water year type
deer_P2S_results <- run_passage_to_spawner_model(observed_adult_input,
                                                 adult_model_covariates,
                                                 "deer creek",
                                                 "wy_type")
# run the model for mill creek and water year type
mill_P2S_results <- run_passage_to_spawner_model(observed_adult_input,
                                                 adult_model_covariates,
                                                 "mill creek",
                                                 "wy_type")
```

# Results

Once the model has been fit to separate streams, you can conbine them into one data frame:
```{r, message = FALSE, warning = FALSE, eval = FALSE}
# join model summaries
P2S_model_fits <- bind_rows(battle_P2S_results$formatted_pars,
                            clear_P2S_results$formatted_pars,
                            mill_P2S_results$formatted_pars,
                            deer_P2S_results$formatted_pars)
```

Current model fits are stored in the `SRJPEmodel` package as the data object `SRJPEmodel::P2S_model_fits` and they are formatted to produce all parameter estimates:

```{r, message = FALSE, warning = FALSE}
knitr::kable(SRJPEmodel::P2S_model_fits |>
               head(10))
```

Now predicted spawners with uncertainty can be produced for streams:

```{r, echo = FALSE, message = FALSE, warning = FALSE, out.width = "600px"}
years_modeled <- get_years_from_P2S_model_fits(P2S_model_fits)

SRJPEmodel::P2S_model_fits |>
  filter(str_detect(par_names, "predicted_spawner")) |>
  mutate(year_index = readr::parse_number(par_names),
         predicted_spawner_count = `50%`,
         lcl = `2.5%`, ucl = `97.5%`) |>
  left_join(years_modeled) |>
  mutate(stream = str_to_title(stream)) |>
  ggplot(aes(x = year, y = predicted_spawner_count)) +
  geom_line(col = wes_palette("GrandBudapest1")[2]) +
  geom_ribbon(aes(ymin = lcl, ymax = ucl), alpha = 0.2) +
  facet_wrap(~stream, scales = "free_y") +
  labs(x = "Year",
       y = "Predicted Spawner Count",
       title = "Predicted Spawner Count for Modeled Tributaries") +
  theme_minimal()
```

We can also see forecasted spawner count for a wet or dry year with uncertainty:

```{r, echo = FALSE, warning = FALSE, message = FALSE}
forecasts <- SRJPEmodel::P2S_model_fits |>
  filter(str_detect(par_names, "abundance_forecast")) |>
  mutate(year_index = readr::parse_number(par_names),
         par_names = ifelse(year_index == "1", "forecast_dry_year", "forecast_wet_year"),
         forecast_level = ifelse(par_names == "forecast_dry_year", "Dry", "Wet"),
         data_type = "forecast",
         forecast_level = ifelse(forecast_level == "Dry", "Low", "High"),
         stream = str_to_title(stream))

forecasts |>
  mutate(adult_count = `50%`,
         lcl = `2.5%`,
         ucl = `97.5%`) |>
  filter(!adult_count %in% c(0, Inf)) |>
  ggplot(aes(x = forecast_level, y = adult_count)) +
  geom_errorbar(aes(x = forecast_level, ymin = lcl, ymax = ucl),
                width = 0.3, alpha = 0.7) +
  geom_point(aes(x = forecast_level, y = adult_count,
                 color = forecast_level),
             size = 4) +
  xlab("Forecast Level") + ylab("Predicted Spawner Count at \n Across-year Mean Passage") +
  scale_color_manual("Forecast Level",
                     values = wes_palette("GrandBudapest1")[2:3]) +
  facet_wrap(~stream, scales = "free") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, size = 15),
        legend.position = "bottom",
        strip.text = element_text(size = 12),
        axis.text = element_text(size = 12),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 12),
        axis.text.x = element_text(angle = 45))
```

# Resources

TODO update this
See `data-raw/adult_model/passage_to_spawner_full_docmentation.Rmd` for full methods.
See `adult data report` for full documentation on adult Chinook salmon data collection.

TODO put the year_index into the function
TODO get_spawning_adults() function that you give stream name and data type

