---
title: "Adult Modeling"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Adult Modeling}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
#library(SRJPEmodel)
#source("adult_model_data_prep.R")
```


## Spawning Adult Abundance in the JPE

The JPE requires an estimate of number of spawning adults for each tributary ideally with associated uncertainty. These estimates will be passed into the spawn-recruit submodel, connecting spawning adults to juvenile production within each tributary.

There are two main methods of getting an estimate for spawning adult abundance: 
1. adult upstream passage counts * pre-spawn mortality
2. Cormack Jolly-Seber model applied to carcass surveys 

For each tributary, a method was selected based on the relative availability, completeness, and quality of adult data sources. These selections are outlined in the Adult Data Report and took into account information from stream teams to recommend adult data sources.

According to the Adult Data Report, the tributaries could be modeled by either approach 1 or 2: 
* Battle Creek, Clear Creek, and Mill Creek: upstream passage and redd counts combined for approach 1
* Deer Creek: upstream passage and holding counts combined for approach 1 
* Butte Creek, Feather River, and Yuba River: carcass surveys used in approach 2. 

### Method 1: Adult Upstream Passage and Prespawn Mortality

#### Data Sources 

Battle Creek, Clear Creek, Deer Creek, and Mill Creek data were combined into one dataset where `spawner_count` represented the survey associated with spawning adults (either `redd_count` or `holding_count`) and `upstream_count` represented the counts of adults passing through the video stations. These counts were summarized by year.

```{r}
survival_model_data_raw |> 
  mutate(spawner_count = ifelse(stream == "deer creek", holding_count, redd_count)) |> 
  ggplot(aes(x = year, y = spawner_count, color = "spawner count")) + 
  geom_line() +
  geom_line(aes(x = year, y = upstream_count, color = "upstream passage")) +
  facet_wrap(~stream) + 
  theme_minimal() +
  xlab("Year") + ylab("Spawner Count") + ggtitle("Spawner Count by Stream")
```
Generally, upstream passage count exceeds spawner count which indicates that some level of prespawn mortality is occurring. 

#### Calculating Prespawn Survival

Prespawn survival, or the proportion of adults that survived from upstream passage to spawn, was calculated as `upstream_count / spawner_count`. If this value exceed `1`, it was set to `1`:
```{r}
survival_model_data_raw |> 
  ggplot(aes(x = year, y = prespawn_survival, color = stream)) +
  geom_line() +
  theme_minimal() +
  xlab("Year") + ylab("Prespawn Survival") + ggtitle("Prespawn Survival by Stream")
```

#### Environmental Covariates 

To better understand the relationship between `upstream_count` and `spawner_count` - i.e. prespawn survival - several environmental covariates were investigated: 
* mean flow (cfs) 
* temperature: total proportion of days exceeding a threshold of 20 degrees Celsius
* temperature: growing degree days (gdd) 
* passage timing: mean, median, and minimum passage timing were all considered 
* water year type (wet or dry) 

The aim was to identify environmental covariates driving prespawn survival and incorporate them into the spawning adult abundance model. When performing these analyses, there were several points to consider: 
* temperature and passage timing could each only be represented once (i.e. mean and median passage timing could not be included in one linear model because of their high correlation - same with growing degree days and proportion of days exceeding the threshold) 
* Mill Creek did not have daily granularity for passage timing and so these variables were not considered 
* Collinearity needed to be accounted for (i.e. several variables were highly correlated with one another) 

With an eye toward eventually building a model with all streams modeled together, we first developed the following methods for identifying key environmental covariates for each stream individually: 
1) Look for correlation among predictor variables - visual inspection of a pairs plot, ruling out correlations above a threshold of 0.65, and using variation inflaction factor (VIF) analysis to eliminate highly correlated variables. 
2) Use information in step 1 to select ONE temperature variable and ONE passage timing variable, as well as any other significant variables. 

The best fitting models for each stream were: 
* Battle Creek: `prespawn_survival ~ 1 + min_passage_timing + gdd * mean_flow` 
* Clear Creek: `prespawn_survival ~ 1 + mean_flow + min_passage_timing * gdd` 
* Deer Creek: `prespawn_survival ~ 1 + water_year_type * median_passage_timing * water_year_type * gdd` 
* Mill Creek: `prespawn_survival ~ 1 + water_year_type * mean_flow` 

Once the best environmental covariates were selected for each stream, the package `glmulti` was used to select the best combination of variables in a linear regression for each stream (based on AIC). The best model for each stream was then implemented in `stan_glm` (package `rstanarm`) to assess its performance in a bayesian framework. 

### Bayesian Multiple Linear Regressions 

#### By Stream

Battle Creek:

```{r}
battle_bayes <- stan_lm(prespawn_survival ~ min_passage_timing + mean_flow * gdd,
                        data = battle_data,
                        prior = R2(0.1))

battle_bayes |>
  gather_draws(`(Intercept)`, min_passage_timing, mean_flow, gdd, `mean_flow:gdd`, sigma) |>
  median_qi()
```

Clear Creek: 

```{r}
clear_bayes <- stan_lm(prespawn_survival ~ mean_flow + min_passage_timing + min_passage_timing * gdd + mean_flow * gdd,
                       data = clear_data,
                       prior = R2(0.1))

clear_bayes |>
  gather_draws(`(Intercept)`, min_passage_timing, mean_flow, gdd, `min_passage_timing:gdd`, `mean_flow:gdd`, sigma) |>
  median_qi()
```

Deer Creek:

```{r}
deer_bayes <- stan_lm(prespawn_survival ~ water_year_type *
                        median_passage_timing * gdd,
                      data = deer_data,
                      prior = R2(0.1))
deer_bayes |>
  gather_draws(`(Intercept)`, water_year_typewet, median_passage_timing, gdd,
               `water_year_typewet:gdd`, `median_passage_timing:gdd`) |>
  median_qi()
```

Mill Creek: 

```{r}
mill_bayes <- stan_lm(prespawn_survival ~ water_year_type * mean_flow,
                      data = mill_data,
                      prior = R2(0.1))
mill_bayes |>
  gather_draws(`(Intercept)`, mean_flow, water_year_typewet, `water_year_typewet:mean_flow`) |>
  median_qi()
```

#### All Streams - Hierarchical






