---
title: "Adult Modeling"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Adult Modeling}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
#library(SRJPEmodel)
source(here::here("data-raw", "adult_model", "dauphin_single_stream.R"))
```


## Spawning Adult Abundance in the JPE

The JPE requires an estimate of number of spawning adults for each tributary ideally with associated uncertainty. These estimates will be passed into the spawn-recruit submodel, connecting spawning adults to juvenile production within each tributary.

There are two main methods of getting an estimate for spawning adult abundance: 
1. adult upstream passage counts * pre-spawn mortality
2. Cormack Jolly-Seber model applied to carcass surveys 

For each tributary, a method was selected based on the relative availability, completeness, and quality of adult data sources. These selections are outlined in the Adult Data Report and took into account information from stream teams to recommend adult data sources.

According to the Adult Data Report, the tributaries could be modeled by either approach 1 or 2: 
* Battle Creek, Clear Creek, and Mill Creek: upstream passage and redd counts combined for approach 1
* Deer Creek: upstream passage and holding counts combined for approach 1 
* Butte Creek, Feather River, and Yuba River: carcass surveys used in approach 2. 

### Method 1: Adult Upstream Passage and Prespawn Mortality

#### Data Sources 

Battle Creek, Clear Creek, Deer Creek, and Mill Creek data were combined into one dataset where `spawner_count` represented the survey associated with spawning adults (either `redd_count` or `holding_count`) and `upstream_count` represented the counts of adults passing through the video stations. These counts were summarized by year.

```{r}
survival_model_data_raw |> 
  mutate(spawner_count = ifelse(stream == "deer creek", holding_count, redd_count)) |> 
  ggplot(aes(x = year, y = spawner_count, color = "spawner count")) + 
  geom_line() +
  geom_line(aes(x = year, y = upstream_count, color = "upstream passage")) +
  facet_wrap(~stream) + 
  theme_minimal() +
  xlab("Year") + ylab("Spawner Count") + ggtitle("Spawner Count by Stream")
```
Generally, upstream passage count exceeds spawner count which indicates that some level of prespawn mortality is occurring. 

#### Calculating Prespawn Survival

Prespawn survival, or the proportion of adults that survived from upstream passage to spawn, was calculated as `upstream_count / spawner_count`. If this value exceed `1`, it was considered to be an anomalous year and was removed from the dataset:
```{r}
survival_model_data_raw |> 
  ggplot(aes(x = year, y = prespawn_survival, color = stream)) +
  geom_line() +
  theme_minimal() +
  xlab("Year") + ylab("Prespawn Survival") + ggtitle("Prespawn Survival by Stream")
```

### Environmental Covariates 

To better understand the relationship between `upstream_count` and `spawner_count` - i.e. prespawn survival - several environmental covariates were investigated from the following categories:
* flow
* temperature
* passage timing
* water year type (wet or dry) 

The aim was to identify environmental covariates driving prespawn survival and incorporate them into the spawning adult abundance model. When performing these analyses, there were several points to consider: 
* temperature and passage timing could be summarized several different ways, and so different summarization methods needed to be compared.
* Mill Creek did not have daily granularity for passage timing and so these variables were not considered.
* Collinearity needed to be accounted for (i.e. several variables were highly correlated with one another).

#### Flow 

We considered two approaches for summarizing flow in cfs: 
1) Mean flow
2) Maximum flow 

Maximum flow was considered to more effectively capture one-off large flow events that would theoretically support migration events. Additionally, upon inspection of the data source across multiple years, average maximum flow over the migratory and holding months (March-May and May-August, respectively) was more representative of the fluctuations in flow over the entire year. We decided to use maximum flow based on those criteria. 


#### Temperature

Several approaches were considered for summarizing temperature:
1) proportion of days where the temperature surpassed a threshold of 20 degrees Celsius (source: https://www.noaa.gov/sites/default/files/legacy/document/2020/Oct/07354626766.pdf)
2) Growing degree days (GDD) with a base temperature of 0 degrees Celsius (source: https://www.researchgate.net/publication/279930331_Fish_growth_and_degree-days_I_Selecting_a_base_temperature_for_a_within-population_study and input from MAT team) 
3) Degree Day 20 (DD20), where cumulative degree days are calculated against a threshold of 20 degrees Celsius (source: https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0204274) 

For each metric approach, we calculated the metric for migration months (March - May) in the Sacramento River and holding months (May - August) in each tributary. We tested both the individual effects of migratory and holding temperatures as well as a cumulative metric (summed migratory and holding temperatures).

We visually inspected regressions of prespawn survival against each of the three temperature metrics. Metrics 1 and 2 did not show a consistent relationship across streams, and in particular metric 1 was not considered to sufficiently capture the relationship between temperature, time exposed to high temperatures, and the cumulative effect of exposure to high temperatures on stress.

#### Passage Timing 

We calculated the passage timing metric at a weekly granularity for streams where such data was available. Mill Creek at the time of this report had not supplied passage data at a finer granularity than annual, and so was excluded from regressions with this metric. 

We considered the following metrics for passage timing: 
1) Median passage timing 
2) Mean passage timing 
3) Minimum passage timing 

We used upstream passage estimates instead of raw counts to calculate prespawn survival, but used raw upstream passage counts to calculate passage timing. Because some years were not collected for raw counts in Clear Creek, some years have prespawn survival and no passage timing (2000-2012).

We did not have a theoretical reason to support one metric over the others, and so all three were analyzed for statistical importance.

#### Water Year Type 

To account for year effects, we used the `waterYearType` package to pull water year assignments as a categorical covariate. Because for some streams we had very few data points (i.e. for Mill Creek, only three years were considered dependable), we simplified all potential categories of water year type into either dry (`Dry`, `Below Normal`, `Critical`) or wet (`Wet`, `Above Normal`).


#### Statistical Importance of Covariates

With an eye toward eventually building a model with all streams modeled together, we first developed the following methods for identifying key environmental covariates for each stream individually: 
1) Look for correlation among predictor variables - visual inspection of a pairs plot, ruling out correlations above a threshold of 0.65, and using variation inflaction factor (VIF) analysis to eliminate highly correlated variables. 
2) Use information in step 1 to select ONE temperature variable and ONE passage timing variable, as well as any other significant variables. 

The best fitting models for each stream were: 
* Battle Creek: `prespawn_survival ~ 1 + min_passage_timing + gdd * mean_flow` 
* Clear Creek: `prespawn_survival ~ 1 + mean_flow + min_passage_timing * gdd` 
* Deer Creek: `prespawn_survival ~ 1 + water_year_type * median_passage_timing * water_year_type * gdd` 
* Mill Creek: `prespawn_survival ~ 1 + water_year_type * mean_flow` 

Once the best environmental covariates were selected for each stream, the package `glmulti` was used to select the best combination of variables in a linear regression for each stream (based on AIC). The best model for each stream was then implemented in `stan_glm` (package `rstanarm`) to assess its performance in a bayesian framework. 

### Bayesian Multiple Linear Regressions 

#### By Stream

Battle Creek:

```{r}
battle_bayes <- stan_lm(prespawn_survival ~ min_passage_timing + mean_flow * gdd,
                        data = battle_data,
                        prior = R2(0.1))

battle_bayes |>
  gather_draws(`(Intercept)`, min_passage_timing, mean_flow, gdd, `mean_flow:gdd`, sigma) |>
  median_qi()
```

Clear Creek: 

```{r}
clear_bayes <- stan_lm(prespawn_survival ~ mean_flow + min_passage_timing + min_passage_timing * gdd + mean_flow * gdd,
                       data = clear_data,
                       prior = R2(0.1))

clear_bayes |>
  gather_draws(`(Intercept)`, min_passage_timing, mean_flow, gdd, `min_passage_timing:gdd`, `mean_flow:gdd`, sigma) |>
  median_qi()
```

Deer Creek:

```{r}
deer_bayes <- stan_lm(prespawn_survival ~ water_year_type *
                        median_passage_timing * gdd,
                      data = deer_data,
                      prior = R2(0.1))
deer_bayes |>
  gather_draws(`(Intercept)`, water_year_typewet, median_passage_timing, gdd,
               `water_year_typewet:gdd`, `median_passage_timing:gdd`) |>
  median_qi()
```

Mill Creek: 

```{r}
mill_bayes <- stan_lm(prespawn_survival ~ water_year_type * mean_flow,
                      data = mill_data,
                      prior = R2(0.1))
mill_bayes |>
  gather_draws(`(Intercept)`, mean_flow, water_year_typewet, `water_year_typewet:mean_flow`) |>
  median_qi()
```

#### All Streams - Hierarchical






