---
title: "Adult Modeling"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Adult Modeling}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
#library(SRJPEmodel)
load(here::here("data-raw", "adult_model", "adult_data_objects.Rdata"))
load(here::here("data-raw", "adult_model", "best_adult_models.Rdata"))
load(here::here("data-raw", "adult_model", "single_stream_dauphin_fits.Rdata"))
```


## Spawning Adult Abundance in the JPE

The JPE requires an estimate of number of spawning adults for each tributary ideally with associated uncertainty. These estimates will be passed into the spawn-recruit submodel, connecting spawning adults to juvenile production within each tributary.

There are two main methods of getting an estimate for spawning adult abundance: 
1. adult upstream passage counts * pre-spawn mortality
2. Cormack Jolly-Seber model applied to carcass surveys 

For each tributary, a method was selected based on the relative availability, completeness, and quality of adult data sources. These selections are outlined in the Adult Data Report and took into account information from stream teams to recommend adult data sources.

According to the Adult Data Report, the tributaries could be modeled by either approach 1 or 2: 
* Battle Creek, Clear Creek, and Mill Creek: upstream passage and redd counts combined for approach 1
* Deer Creek: upstream passage and holding counts combined for approach 1 
* Butte Creek, Feather River, and Yuba River: carcass surveys used in approach 2. 

### Method 1: Adult Upstream Passage and Prespawn Mortality

#### Data Sources 

Battle Creek, Clear Creek, Deer Creek, and Mill Creek data were combined into one dataset where `spawner_count` represented the survey associated with spawning adults (either `redd_count` or `holding_count`) and `upstream_count` represented the counts of adults passing through the video stations. These counts were summarized by year.

```{r}
adult_data_objects$survival_model_data_raw |> 
  mutate(spawner_count = ifelse(stream == "deer creek", holding_count, redd_count)) |> 
  ggplot(aes(x = year, y = spawner_count, color = "spawner count")) + 
  geom_line() +
  geom_line(aes(x = year, y = upstream_count, color = "upstream passage")) +
  facet_wrap(~stream) + 
  theme_minimal() +
  xlab("Year") + ylab("Spawner Count") + ggtitle("Spawner Count by Stream")
```
Generally, `upstream count` exceeded `spawner count`, indicating that some level of prespawn mortality is occurring. Any years where `spawner count` exceeded `upstream count` was removed from the dataset as it was not considered dependable. This limited the data for some streams, but most especially Mill Creek, which had three data points.

#### Calculating Prespawn Survival

Prespawn survival, or the proportion of adults that survived from upstream passage to spawn, was calculated as `upstream_count / spawner_count`. 
```{r}
adult_data_objects$survival_model_data_raw |> 
  ggplot(aes(x = year, y = prespawn_survival, color = stream)) +
  geom_line() +
  theme_minimal() +
  xlab("Year") + ylab("Prespawn Survival") + ggtitle("Prespawn Survival by Stream")
```

### Environmental Covariates 

To better understand the relationship between `upstream count` and `spawner count` - i.e. `prespawn survival` - environmental covariates were investigated from the following categories:
* flow
* temperature
* upstream passage timing
* water year type (wet or dry) 

The aim was to identify environmental covariates driving prespawn survival and incorporate them into the spawning adult abundance model. When performing these analyses, there were several points to consider: 
* temperature, passage timing, and flow could be summarized several different ways, and so different summarization methods needed to be compared within those categories. 
* Collinearity needed to be accounted for among the predictor variables. 

#### Flow 

We considered two approaches for summarizing flow in cubic feet per second (cfs): 
1) Mean flow
2) Maximum flow 

Maximum flow was considered to more effectively capture one-off large flow events that would theoretically support migration events. Additionally, upon inspection of the data source across multiple years, average maximum flow over the migratory and holding months (March-May and May-August, respectively) was more representative of the fluctuations in flow over the entire year. We decided to use maximum flow based on those criteria. 


#### Temperature

Several approaches were considered for summarizing temperature:
1) proportion of days where the temperature surpassed a threshold of 20 degrees Celsius (source: https://www.noaa.gov/sites/default/files/legacy/document/2020/Oct/07354626766.pdf)
2) Growing degree days (GDD) with a base temperature of 0 degrees Celsius (source: https://www.researchgate.net/publication/279930331_Fish_growth_and_degree-days_I_Selecting_a_base_temperature_for_a_within-population_study and input from MAT team) 
3) Degree Day 20 (DD20), where cumulative degree days are calculated against a threshold of 20 degrees Celsius (source: https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0204274) 

For each metric approach, we calculated the metric for migration months (March - May) in the Sacramento River and holding months (May - August) in each tributary. We tested both the individual effects of migratory and holding temperatures as well as a cumulative metric (summed migratory and holding temperatures).

We visually inspected regressions of prespawn survival against each of the three temperature metrics. Metrics 1 and 2 did not show a consistent relationship across streams, and in particular metric 1 was not considered to sufficiently capture the relationship between temperature, time exposed to high temperatures, and the cumulative effect of exposure to high temperatures on stress.

```{r}
adult_data_objects$survival_model_data_raw |>  
  filter(stream != "mill creek") |> 
  ggplot(aes(x = total_prop_days_exceed_threshold, y = prespawn_survival, color = stream)) + 
  geom_smooth(method = "lm") + 
  ggtitle("Proportion of days exceeding threshold as predictor variable")
```

```{r}
adult_data_objects$survival_model_data_raw |> 
  filter(stream != "mill creek") |> 
  ggplot(aes(x = gdd_total, y = prespawn_survival, color = stream)) + 
  geom_smooth(method = "lm") + 
  ggtitle("Degree days (20) as predictor variable")
```



#### Passage Timing 

We calculated the passage timing metric at a weekly granularity for streams where such data was available. 

We considered the following metrics for passage timing: 
1) Median passage timing 
2) Mean passage timing 
3) Minimum passage timing 

We used upstream passage estimates instead of raw counts to calculate prespawn survival, but used raw upstream passage counts to calculate passage timing. Because some years were not collected for raw counts in Clear Creek, some years have prespawn survival and no passage timing (2000-2012).

Minimum passage timing could theoretically capture not only passage timing but also how long fish were exposed to higher temperatures (i.e. the earlier the first passage timing, the less time exposed to high temperatures later in the year), inspection of plots of passage counts by year and stream showed that the bulk of the fish were not being captured by the minimum passage metric.

Median and mean passage timing were very similar across years, rarely differing by more than 2 weeks:

```{r}
adult_data_objects$survival_model_data_raw |> 
  mutate(diff = median_passage_timing - mean_passage_timing) |> 
  ggplot(aes(x = year, y = diff)) + 
  geom_line() +
  facet_wrap(~stream)
```

We decided upon median passage timing over mean passage timing as it was more represented in automated model selection.

#### Water Year Type 

To account for year effects, we used the `waterYearType` package to pull water year assignments as a categorical covariate. Because for some streams we had very few data points (i.e. for Mill Creek, only three years were considered dependable), we simplified all potential categories of water year type into either dry (`Dry`, `Below Normal`, `Critical`) or wet (`Wet`, `Above Normal`).

Because some datasets were so small due to anomalous years where `prespawn survival > 1`, some streams were reduced to only having either `wet` or `dry` years represented:

```{r}
adult_data_objects$survival_model_data_raw |> 
  filter(stream == "mill creek") |>
  distinct(stream, water_year_type)
```
```{r}
adult_data_objects$survival_model_data_raw |> 
  filter(stream == "clear creek") |> 
  distinct(water_year_type, stream)
```
Ultimately, `water_year_type` could not be used for Mill Creek or Clear Creek, but as more data become available it should be incorporated as a potentially important variable.

#### Statistical Importance of Covariates

We developed the following methods for identifying key environmental covariates for each stream individually: 
1) Look for correlation among predictor variables - visual inspection of a pairs plot, ruling out correlations above a threshold of 0.65, and using variation inflaction factor (VIF) analysis to eliminate highly correlated variables. 
2) Use information in step 1 to remove any confounding variables. 
3) Use the package `glmulti` to select the best combination of remaining variables in a linear regression based on AIC. 

The best fitting models for each stream were: 
* Battle Creek: ```{r} best_adult_models$best_battle_lm``` 
* Clear Creek: ```{r} best_adult_models$best_clear_lm``` 
* Deer Creek: ```{r} best_adult_models$best_deer_lm``` 
* Mill Creek: ```{r} best_adult_models$best_deer_lm```  

### Single Stream Dauphin model

Once the environmental variables with the most significant predictive power were selected for each stream, they were implemented in a single stream model based off of Dauphin et al. (2010). The model is coded in `rstan` and produces estimates of prespawn survival (mean `mu_k` and standard deviation `sigma_k`), as well as upstream passage (log-scale mean `mu_alpha` and log-scale standard deviation `sigma_alpha`). The results were examined for several diganostics: 
* N eff ratio 
* Traceplots 
* Density overlay plots 
* Rhat 
* Autocorrelation

#### Battle

```{r}
mcmc_trace(single_stream_dauphin_fits$battle_dauphin, pars = c("mu_k", "sigma_k", "mu_a", "sigma_a"))
mcmc_areas(single_stream_dauphin_fits$battle_dauphin, pars = c("mu_k", "sigma_k", "mu_a", "sigma_a"))
mcmc_dens_overlay(single_stream_dauphin_fits$battle_dauphin, pars = c("mu_k", "sigma_k",  "mu_a", "sigma_a"))
neff_ratio(single_stream_dauphin_fits$battle_dauphin, pars = c("mu_k", "sigma_k", "mu_a", "sigma_a"))
mcmc_acf(single_stream_dauphin_fits$battle_dauphin, pars = c("mu_k", "sigma_k", "mu_a", "sigma_a"))
rhat(single_stream_dauphin_fits$battle_dauphin, c("mu_k", "sigma_k", "mu_a", "sigma_a"))
```

#### Clear

```{r}
mcmc_trace(single_stream_dauphin_fits$battle_dauphin, pars = c("mu_k", "sigma_k", "mu_a", "sigma_a"))
mcmc_areas(single_stream_dauphin_fits$battle_dauphin, pars = c("mu_k", "sigma_k", "mu_a", "sigma_a"))
mcmc_dens_overlay(single_stream_dauphin_fits$battle_dauphin, pars = c("mu_k", "sigma_k",  "mu_a", "sigma_a"))
neff_ratio(single_stream_dauphin_fits$battle_dauphin, pars = c("mu_k", "sigma_k", "mu_a", "sigma_a"))
mcmc_acf(single_stream_dauphin_fits$battle_dauphin, pars = c("mu_k", "sigma_k", "mu_a", "sigma_a"))
rhat(single_stream_dauphin_fits$battle_dauphin, c("mu_k", "sigma_k", "mu_a", "sigma_a"))
```

#### Mill

```{r}
mcmc_trace(single_stream_dauphin_fits$mill_dauphin, pars = c("mu_k", "sigma_k", "mu_a", "sigma_a"))
mcmc_areas(single_stream_dauphin_fits$mill_dauphin, pars = c("mu_k", "sigma_k", "mu_a", "sigma_a"))
mcmc_dens_overlay(single_stream_dauphin_fits$mill_dauphin, pars = c("mu_k", "sigma_k",  "mu_a", "sigma_a"))
neff_ratio(single_stream_dauphin_fits$mill_dauphin, pars = c("mu_k", "sigma_k", "mu_a", "sigma_a"))
mcmc_acf(single_stream_dauphin_fits$mill_dauphin, pars = c("mu_k", "sigma_k", "mu_a", "sigma_a"))
rhat(single_stream_dauphin_fits$mill_dauphin, c("mu_k", "sigma_k", "mu_a", "sigma_a"))
```

#### Deer

```{r}
mcmc_trace(single_stream_dauphin_fits$deer_dauphin, pars = c("mu_k", "sigma_k", "mu_a", "sigma_a"))
mcmc_areas(single_stream_dauphin_fits$deer_dauphin, pars = c("mu_k", "sigma_k", "mu_a", "sigma_a"))
mcmc_dens_overlay(single_stream_dauphin_fits$deer_dauphin, pars = c("mu_k", "sigma_k",  "mu_a", "sigma_a"))
neff_ratio(single_stream_dauphin_fits$deer_dauphin, pars = c("mu_k", "sigma_k", "mu_a", "sigma_a"))
mcmc_acf(single_stream_dauphin_fits$deer_dauphin, pars = c("mu_k", "sigma_k", "mu_a", "sigma_a"))
rhat(single_stream_dauphin_fits$deer_dauphin, c("mu_k", "sigma_k", "mu_a", "sigma_a"))
```





